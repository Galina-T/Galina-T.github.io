(()=>{"use strict";let e=new Date;const t=document.querySelector("#releaseDate"),n=document.getElementById("date_field");e.setDate(e.getDate()),t.textContent=e.toLocaleDateString("ru",{year:"numeric",month:"2-digit",day:"2-digit",hour12:!1});const s=document.querySelector(".teamName"),o=s.classList;s.addEventListener("click",(()=>{const e=o.toggle("teamNameNew");s.textContent=e?"Образовательные платформы":"Gallllery"}));const r={Эпик:"🔨",История:"🔨",Задача:"🔨",Подзадача:"🔨",Ошибка:"🐞",Дизайн:"🎨","Подзадача на ошибку":"🐞","Подзадача на дизайн":"🎨","Подзадача на разработку":"🔨"},c=["задачу","задачи","задач"];let a="Пользовательское поле (Затронутые сервисы)",l="Исправить в версиях";const i=(e,t)=>{const n=e/t,s=Math.floor(10*n);return{start:"🀰".repeat(s)+"🚀",finish:"🀰".repeat(10-s)+" "+Math.round(1e3*n)/10+"%"}},u=e=>document.querySelector(e).content.cloneNode(!0),d=(e,t,n)=>{t=e.reduce(((e,t)=>e+t.tasks.length),0),document.querySelector(".progress_start").textContent=i(t,n).start,document.querySelector(".progress_finish").textContent=i(t,n).finish},p=(e,t)=>({prod:[{text:"Done",tasks:e.filter((e=>e.version.includes(t)&&"Готово"==e.status)),clname:"done"},{text:"частично - требуется коррекция",tasks:e.filter((e=>e.version.includes(t)&&("Correction"==e.status||"Testing"==e.status||"Сделать"==e.status||"В работе"==e.status||"READY FOR TESTING"==e.status))),clname:"correction"},{text:"в дополнительном тестировании",tasks:e.filter((e=>e.version.includes(t)&&("Tested"==e.status||"in release"==e.status))),clname:"tested"},{text:"ждёт ревью",tasks:e.filter((e=>e.version.includes(t)&&"Review"==e.status)),clname:"review"}],backlog:[{text:"в ожидании Hotfix",tasks:e.filter((e=>!e.version.includes(t)&&"Hotfix"==e.priority&&"Готово"!=e.status)),clname:"hotfix"},{text:"уже в работе",tasks:e.filter((e=>!e.version.includes(t)&&"Hotfix"!=e.priority&&"В работе"==e.status)),clname:"work"},{text:"уже на тестировании",tasks:e.filter((e=>!e.version.includes(t)&&"Hotfix"!=e.priority&&("READY FOR TESTING"==e.status||"Testing"==e.status||"Tested"==e.status))),clname:"tested"},{text:"в очереди на реализацию",tasks:e.filter((e=>!e.version.includes(t)&&"Hotfix"!=e.priority&&("Correction"==e.status||"Сделать"==e.status))),clname:"notInRelease"},{text:"ждёт ревью",tasks:e.filter((e=>!e.version.includes(t)&&"Review"==e.status)),clname:"review"},{text:"On hold",tasks:e.filter((e=>!e.version.includes(t)&&"On hold"==e.status)),clname:"onHold"},{text:"отправили в архив",tasks:e.filter((e=>!e.version.includes(t)&&"Archive"==e.status)),clname:"archive"}]}),y=(e,t)=>{const n=[...t.children];for(let e=1;e<n.length;e++)n[e].remove();e.forEach((e=>{const n=e.tasks.length;if(n>0){const s=u("#statusTemplate"),o=s.querySelector(".count"),c=s.querySelector(".list_tasks");o.textContent=n+" "+e.text,o.classList.add(e.clname),e.tasks.forEach((e=>{const t=u("#taskTemplate"),n=t.querySelector(".task_link"),s=t.querySelector(".icon"),o=t.querySelector(".task_text");n.setAttribute("href",`https://jira.burgdev.ru/browse/${e.taskID}`),n.setAttribute("target","_blank"),s.textContent=r[e.type],o.textContent=e.taskID+" "+e.name,c.appendChild(t)})),t.appendChild(s)}}))},m=e=>{let t=[];return e.forEach((e=>{e.tasks.length>0&&e.tasks.forEach((e=>{t=t.concat(e.affectedServices).filter((e=>""!=e))}))})),[...new Set(t)]},f=(e,t)=>{[...t.children].forEach((e=>e.remove())),e.forEach((e=>{const n=u("#serviceTypeTemplate");n.querySelector(".service").textContent=`${e};`,t.appendChild(n)}))};n.addEventListener("input",(function(e){document.querySelector("#releaseDate").textContent=e.target.value.replace(/(\d*)-(\d*)-(\d*)/,"$3.$2.$1")}));const h=document.querySelector("select[name='selectVersions']");let v;h.addEventListener("change",(function(e){const t=e.target.value;x=p(v,t),S=m(x.prod),y(x.prod,q),y(x.backlog,_),f(S,C),d(x.prod,g,k)}));let x={},S=[],g=0,k=0;const q=document.querySelector(".statuses_block__prod"),_=document.querySelector(".statuses_block__backlog"),C=document.querySelector(".affectedServices_list");document.getElementById("csvFile").addEventListener("change",(function(e){const t=e.target.files[0],n=new FileReader;document.querySelector(".input-file-text").textContent=t.name,console.dir(e.target),console.dir(t.name),n.onload=function(e){const t=e.target.result;v=csv_parse_sync.parse(t,{delimiter:"|"});const n=v.splice(0,1)[0];v=v.map((e=>{let t=new Object;return n.forEach(((e,n)=>{t[e]=null==t[e]?""+n:t[e]+" "+n})),{type:e[t["Тип задачи"]],status:e[t["Статус"]],name:e[t["Тема"]],affectedServices:""==t[a]?[]:t[a].split(" ").map((t=>e[t])),taskID:e[t["Ключ проблемы"]],priority:e[t["Приоритет"]],version:""==t[l]?[]:t[l].split(" ").map((t=>e[t]))}}));const s=v.reduce(((e,t)=>e.concat(t.version)),[]).filter((e=>""!=e));[...new Set(s)].forEach((e=>{const t=u("#optionVersion"),n=t.querySelector(".option");n.textContent=`${e}`,n.setAttribute("name",`${e}`),h.appendChild(t)}));const o=[{count:(r=v).filter((e=>"Задача"==e.type||"Подзадача"==e.type||"История"==e.type||"Эпик"==e.type||"Подзадача на разработку"==e.type)).length,description:"на разработку"},{count:r.filter((e=>"Ошибка"==e.type||"Подзадача на ошибку"==e.type)).length,description:"на исправление багов"},{count:r.filter((e=>"Дизайн"==e.type||"Подзадача на дизайн"==e.type)).length,description:"на дизайн"}];var r;x=p(v,h.value),k=v.length;const i=((e,t)=>{let n;return n=t>100?t%100:t<=20&&t>=10?t:t>20?t%10:t,1==n?e[0]:n>1&&n<5?e[1]:e[2]})(c,k);d(x.prod,g,k),S=m(x.prod),document.querySelector("#container");const E=document.querySelector(".total_tasks"),T=document.querySelector(".list_types"),b=(document.querySelector(".list_status"),document.querySelector(".ending"));E.textContent=`${k}`,b.textContent=`${i}`;const w=u("#countTypeTemplate");w.querySelector(".type_count"),w.querySelector(".type_title"),o.forEach((e=>{if(e.count>0){const t=u("#countTypeTemplate"),n=t.querySelector(".type_count"),s=t.querySelector(".type_title");n.textContent=`${e.count}`,s.textContent=`${e.description}`,T.appendChild(t)}})),y(x.prod,q),y(x.backlog,_),f(S,C)},n.readAsText(t)}))})();